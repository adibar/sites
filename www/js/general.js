          // <p style='margin-left: 160px; text-align: center; background-color: rgb(255, 255, 255);'>
          //   <img src='http://127.0.0.1:8000/static/img/media/IMG_1772.jpg' alt='' style='width: 605px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; text-align: right; float: left; margin: 0px 10px 10px 0px; background-color: initial;'>
          // </p>
          // <p style='text-align: left; margin-left: 760px; direction: ltr;'>
          //   28/10/2014
          // </p>
          // <h1 style='text-align: center;'><span style='color: rgb(54, 96, 146);'><em>איך אני תופס את הרגעים הללו?</em></span></h1>
          // <p>
          //   <em><br>
          //   </em>
          // </p>
          // <p>
          //   <span style='font-size: 18px;'><em>לאחורונה עוצרים אותי הרבה ברחוב ושואלים אותי,</em></span>
          // </p>
          // <p>
          //   <span style='font-size: 18px;'><span style='color: rgb(165, 165, 165);'><em>&nbsp; &nbsp;&nbsp;איך לעזעזל את תופס את הרגעים הללו?</em></span></span>
          // </p>
          // <p>
          //   <span style='font-size: 18px;'><span style='color: rgb(165, 165, 165);'><em><br>
          //   </em></span></span>
          // </p>
          // <p>
          //   <span style='font-size: 18px;'><em><span style='color: rgb(0, 0, 0);'>אין לי תשובה אמיתי לשאלה הזאת, אבל סוד אחד אני יכול לגלות לכם:</em></span></span>
          // </p>
          // <p>
          //   <span style='font-size: 18px;'><span style='color: rgb(0, 0, 0);'><em>את האווירה, התחושה והאמונה במה שאני עושה, אף אחד לא יכול לפספס. זה נובע ממני ומהאנרגיות בסטודיו שלי. נעים לי ונעים לדוגמנים.</em></span></span>
          // </p>
          // <p>
          //   <span style='font-size: 18px;'><span style='color: rgb(0, 0, 0);'><em>אז קדימה, עכשיו את יודעים, פשוט תהיו מי שאתם</em></span></span>
          // </p>
          // <p>
          //   <span><span style='color: rgb(0, 0, 0);'><em><strong></strong><span style='font-size: 20px;'><strong>ותתחילו לצלם!!!</strong></em></span></span></span>
          // </p>
          // <p>
          //   <span><span style='color: rgb(0, 0, 0);'><em><span style='font-size: 20px;'><strong>שלכם,&nbsp;</strong></em></span></span></span><a href='http://ynet.co.il' target='_blank'><span style='font-size: 20px;'><span style='color: rgb(54, 96, 146);'>עדי ברון&nbsp;</span></span></a>
          // </p>
          // <p style='text-align: center; margin-left: 160px;'>
          // </p>


// var jsonObj = { 
//   "css": {

//   },
//   "menu":{
//     "type":"top-menu",
//     "pages":[
//       [{"name":"Home", "url":"/index.html"},],  
//       [{"name":"About", "url":"/about.html"},],
//       [{"name":"Blog", "url":"/blog.html"},],
//       [{"name":"Specials", "url":"/specials.html"},],  
//       [{"name":"Weedings", "url":"/weddings.html"},],  
//       [{"name":"Contact", "url":"/contact.html"},],                      
//     ],
//     "view":{
//       'active': "Home",
//     },
//   },
//   "pages": {
//     'About': [
//       {
//         "widget_name": 'masonary-gallery',
//         'css': {

//         },
//         'data':{
//           'photos': [
//             { 'url': '/static/img/media/IMG_1531.jpg' },
//             { 'url': '/static/img/media/IMG_1536.jpg' },
//             { 'url': '/static/img/media/IMG_1549.jpg' },
//             { 'url': '/static/img/media/IMG_1558.jpg' },
//             { 'url': '/static/img/media/IMG_1564.jpg' },
//             { 'url': '/static/img/media/IMG_1570.jpg' },
//             { 'url': '/static/img/media/IMG_1578.jpg' },
//             { 'url': '/static/img/media/IMG_1582.jpg' },
//             { 'url': '/static/img/media/IMG_1588.jpg' },
//             { 'url': '/static/img/media/IMG_1606.jpg' },
//             { 'url': '/static/img/media/IMG_1617.jpg' },
//             { 'url': '/static/img/media/IMG_1634.jpg' },
//             { 'url': '/static/img/media/IMG_1637.jpg' },
//             { 'url': '/static/img/media/IMG_1641.jpg' },
//             { 'url': '/static/img/media/IMG_1724.jpg' },
//             { 'url': '/static/img/media/IMG_1729.jpg' },            
//             { 'url': '/static/img/media/IMG_1760.jpg' },            
//             { 'url': '/static/img/media/IMG_1772.jpg' },                                                
//           ]
//         }                          
//       },
//     ],
//     'Blog': [
//       {
//         "widget_name": 'slick-gallery',
//         'css': {

//         },
//         'data':{
//           'photos': [
//             { 'url': '/static/img/media/IMG_1641.jpg' },
//             { 'url': '/static/img/media/IMG_1724.jpg' },
//             { 'url': '/static/img/media/IMG_1729.jpg' },            
//             { 'url': '/static/img/media/IMG_1760.jpg' },            
//             { 'url': '/static/img/media/IMG_1772.jpg' },       
//             { 'url': '/static/img/media/1.jpg' },
//             { 'url': '/static/img/media/2.jpg' },
//             { 'url': '/static/img/media/3.jpg' },
//             { 'url': '/static/img/media/5.jpg' },
//             { 'url': '/static/img/media/6.jpg' },          
//           ]
//         }
//       },
//     ],
//     'Specials': [],
//     'Weddings': [],
//     'Contact': [],
//     'Home': [
//       {
//         "widget_name": 'multi-elements',
//         "css": {

//         },
//         'data': {
//           'elements': [
//             { 'photo': { 'url': '/static/img/media/IMG_1531.jpg' }, 'h1': 'I am h1 1', 'txt': 'I am txt, this is so great to be txt 1 ... I am txt, this is so great to be txt 1 ... I am txt, this is so great to be txt 1 ... I am txt, this is so great to be txt 1 ... I am txt, this is so great to be txt 1 ... I am txt, this is so great to be txt 1 ...' },
//             { 'photo': { 'url': '/static/img/media/1.jpg' },        'h1': 'I am h1 2', 'txt': 'I am txt, this is so great to be txt 2 ...' },
//             { 'photo': { 'url': '/static/img/media/IMG_1637.jpg' }, 'h1': 'I am h1 3', 'txt': 'I am txt, this is so great to be txt 3 ...' },
//             { 'photo': { 'url': '/static/img/media/IMG_1588.jpg' }, 'h1': 'I am h1 4', 'txt': 'I am txt, this is so great to be txt 4 ...' },
//             { 'photo': { 'url': '/static/img/media/IMG_1634.jpg' }, 'h1': 'I am h1 5', 'txt': 'I am txt, this is so great to be txt 5 ...' },
//             { 'photo': { 'url': '/static/img/media/3.jpg' },        'h1': 'I am h1 6', 'txt': 'I am txt, this is so great to be txt 6 ...' },
//           ]
//         }
//       },
//       {
//         "widget_name": 'general-txt',
//         "css": {

//         },
//         'data': "<p style='text-align: center; background-color: rgb(255, 255, 255); display:inline;'><img src='http://127.0.0.1:8000/static/img/media/IMG_1772.jpg' alt='' style='width: 690px; float: left; margin: 0px 10px 10px 0px;' helvetica='' neue',='' helvetica,='' arial,='' sans-serif;='' text-align:='' right;='' float:='' left;='' margin:='' 0px='' 10px='' 0px;='' background-color:='' initial;'=''></p><p style='text-align: justify; margin-left: 760px;'></p><h1 style='text-align: center;'><span style='color: rgb(54, 96, 146);'><em>איך אני תופס את הרגעים הללו?</em></span></h1><p><em><br></em></p><p><span style='font-size: 18px;'><em>לאחורונה עוצרים אותי הרבה ברחוב ושואלים אותי,</em></span></p><p><span style='font-size: 18px;'><span style='color: rgb(165, 165, 165);'><em>&nbsp; &nbsp;&nbsp;איך לעזעזל את תופס את הרגעים הללו?</em></span></span></p><p><span style='font-size: 18px;'><span style='color: rgb(165, 165, 165);'><em><br></em></span></span></p><p><span style='font-size: 18px;'><em><span style='color: rgb(0, 0, 0);'>אין לי תשובה אמיתי לשאלה הזאת, אבל סוד אחד אני יכול לגלות לכם:</span></em></span></p><p><span style='font-size: 18px;'><span style='color: rgb(0, 0, 0);'><em>את האווירה, התחושה והאמונה במה שאני עושה, אף אחד לא יכול לפספס. זה נובע ממני ומהאנרגיות בסטודיו שלי. נעים לי ונעים לדוגמנים.</em></span></span></p><p><span style='font-size: 18px;'><span style='color: rgb(0, 0, 0);'><em>אז קדימה, עכשיו את יודעים, פשוט תהיו מי שאתם</em></span></span></p><p><span style='color: rgb(0, 0, 0);'><em><strong></strong><span style='font-size: 20px;'><strong>ותתחילו לצלם!!!</strong></span></em></span></p><p style='direction: rtl; text-align: right;'><span style='color: rgb(0, 0, 0);'><em><span style='font-size: 20px;'><strong>שלכם,&nbsp;</strong></span></em></span><a href='http://ynet.co.il' target='_blank'><span style='font-size: 20px;'><span style='color: rgb(54, 96, 146);'>עדי ברון&nbsp;</span></span></a></p><p style='text-align: center; margin-left: 160px;'></p>"
//       },
//       {
//         "widget_name": 'slick-gallery',
//         'css': {

//         },
//         'data':{
//           'photos': [
//             { 'url': '/static/img/media/IMG_1531.jpg' },
//             { 'url': '/static/img/media/IMG_1536.jpg' },
//             { 'url': '/static/img/media/IMG_1549.jpg' },
//             { 'url': '/static/img/media/IMG_1558.jpg' },
//             { 'url': '/static/img/media/IMG_1564.jpg' },
//             { 'url': '/static/img/media/IMG_1570.jpg' },
//             { 'url': '/static/img/media/IMG_1578.jpg' },
//             { 'url': '/static/img/media/IMG_1582.jpg' },
//             { 'url': '/static/img/media/IMG_1588.jpg' },
//             { 'url': '/static/img/media/IMG_1606.jpg' },
//             { 'url': '/static/img/media/IMG_1617.jpg' },
//             { 'url': '/static/img/media/IMG_1634.jpg' },
//             { 'url': '/static/img/media/IMG_1637.jpg' },
//             { 'url': '/static/img/media/IMG_1641.jpg' },
//             { 'url': '/static/img/media/IMG_1724.jpg' },
//             { 'url': '/static/img/media/IMG_1729.jpg' },            
//             { 'url': '/static/img/media/IMG_1760.jpg' },            
//             { 'url': '/static/img/media/IMG_1772.jpg' },       
//             { 'url': '/static/img/media/1.jpg' },
//             { 'url': '/static/img/media/2.jpg' },
//             { 'url': '/static/img/media/3.jpg' },
//             { 'url': '/static/img/media/5.jpg' },
//             { 'url': '/static/img/media/6.jpg' },
//             { 'url': '/static/img/media/7.jpg' },
//             { 'url': '/static/img/media/1.jpg' },
//             { 'url': '/static/img/media/2.jpg' },
//             { 'url': '/static/img/media/3.jpg' },
//             { 'url': '/static/img/media/5.jpg' },
//             { 'url': '/static/img/media/6.jpg' },
//             { 'url': '/static/img/media/7.jpg' },                  
//           ]
//         }
//       },
//       {
//         "widget_name": 'slick-gallery',
//         'css': {

//         },
//         'data':{
//           'photos': [
//             { 'url': '/static/img/media/IMG_1641.jpg' },
//             { 'url': '/static/img/media/IMG_1724.jpg' },
//             { 'url': '/static/img/media/IMG_1729.jpg' },            
//             { 'url': '/static/img/media/IMG_1760.jpg' },            
//             { 'url': '/static/img/media/IMG_1772.jpg' },       
//             { 'url': '/static/img/media/1.jpg' },
//             { 'url': '/static/img/media/2.jpg' },
//             { 'url': '/static/img/media/3.jpg' },
//             { 'url': '/static/img/media/5.jpg' },
//             { 'url': '/static/img/media/6.jpg' },          
//           ]
//         }
//       },
//       {
//         "widget_name": 'masonary-gallery',
//         'css': {

//         },
//         'data':{
//           'photos': [
//             { 'url': '/static/img/media/IMG_1531.jpg' },
//             { 'url': '/static/img/media/IMG_1536.jpg' },
//             { 'url': '/static/img/media/IMG_1549.jpg' },
//             { 'url': '/static/img/media/IMG_1558.jpg' },
//             { 'url': '/static/img/media/IMG_1564.jpg' },
//             { 'url': '/static/img/media/IMG_1570.jpg' },
//             { 'url': '/static/img/media/IMG_1578.jpg' },
//             { 'url': '/static/img/media/IMG_1582.jpg' },
//             { 'url': '/static/img/media/IMG_1588.jpg' },
//             { 'url': '/static/img/media/IMG_1606.jpg' },
//             { 'url': '/static/img/media/IMG_1617.jpg' },
//             { 'url': '/static/img/media/IMG_1634.jpg' },
//             { 'url': '/static/img/media/IMG_1637.jpg' },
//             { 'url': '/static/img/media/IMG_1641.jpg' },
//             { 'url': '/static/img/media/IMG_1724.jpg' },
//             { 'url': '/static/img/media/IMG_1729.jpg' },            
//             { 'url': '/static/img/media/IMG_1760.jpg' },            
//             { 'url': '/static/img/media/IMG_1772.jpg' },                                                
//           ]
//         }                          
//       },
//     ]
//   }
// };

var jsonObj;
var jsonObj_orig;
var picndoOBJs = {}

// TEMPLATES
var image_manager_templete;
var t_controllers;


$(document).ready(function () {

  $(document).on('mouseenter', '.picndo-editable', function() { 
    $(this).css("border", "2px dotted orange");
    $(this).find('.edit_menu').css("visibility", "visible")
  });
  $(document).on('mouseleave', '.picndo-editable', function() { 
    // $(this).css("border", "none");
    $(this).css("border", "2px dotted transparent")
    $(this).find('.edit_menu').css("visibility", "hidden")
  });

  $('body').load('html/stracture.html', function() {


    var source = $('#image-manager').html().replace(/[\u200B]/g, '');
    image_manager_templete = Handlebars.compile(source);
    source = $('#t_controllers').html().replace(/[\u200B]/g, '');
    t_controllers = Handlebars.compile(source);

    Handlebars.registerPartial("image-manager-img", $("#image-manager-img").html().replace(/[\u200B]/g, '') );
    Handlebars.registerPartial("image-manager-obj-list", $("#image-manager-obj-list").html().replace(/[\u200B]/g, '') );     
    Handlebars.registerHelper("ifCond",function(v1,operator,v2,options) {
      return ifCond(v1,operator,v2,options);
    });       
    
    // $('#content').redactor({
    //   lang:           'he',
    //   imageUpload:    '/siteseditor/image_upload',
    //   // imageUpload:    '/siteseditor/images',
    //   imageGetJson:   '/siteseditor/images',
    //   plugins:        ['fontcolor','fontsize','fullscreen','custombutton'],
    // });
    
    // $(".floating-menu").draggable( { containment: "#contentcontainer", scroll: false } );
    $(".floating-menu").draggable( { containment: "#draggables-container", scroll: false } );

    $(window).scroll(function () {
      if ($(this).scrollTop() > 600) {
        $('.scrollup').fadeIn();
      } else {
        $('.scrollup').fadeOut();
      }
    });

    $('.scrollup').click(function () {
      $("html, body").animate({
        scrollTop: 0
      }, 600);
      return false;
    });

    // storeData(1, jsonObj);
    jsonObj = getData(1);


    // var ldiv1 = jQuery('<div/>', {
    //   class: 'row .picndo-editable'
    // });
    // $("#contentcontainer").append(ldiv1);
    // $.getScript("widgets/" + data.menu.type + "/" + data.menu.type + ".js", function() {
    //   //loadmenu($("#contentcontainer"), "widgets/top-menu/", data);
    //   loadmenu(ldiv1, "widgets/top-menu/", data);
    // });

    // var pageData = data["pages"][data["menu"]["view"]["active"]];
    var pageData = jsonObj["pages"][jsonObj["menu"]["view"]["active"]];
    loadMenu( $("#menucontainer"), $("#contentcontainer"),  pageData );  
    loadPage( $("#contentcontainer"), pageData );  

    // $(".mypopover").popover({ trigger: "hover" });
    $('[data-toggle="popover"]').popover( { /*placement: "auto right"*/ });

    
    jsonObj_orig = _.clone(jsonObj, true);
    start_diff();  



  });
});

function start_diff() {
  window.setInterval( function() {
    
    var current = _.clone(jsonObj, true);

    remove_ids(jsonObj_orig);

    // active & element ids may change
    current.menu.view.active = jsonObj_orig.menu.view.active ;
    remove_ids(current);

    if (!(_.isEqual(jsonObj_orig, current))) {
      // modification happened => alert user
      $("#save-btn").css( "display", "block" );
    }
  }, 5000);    
}

function save_diff() {
  storeData(1, jsonObj);
  jsonObj_orig = _.clone(jsonObj, true);
  $("#save-btn").css( "display", "none" );
}

function remove_ids(lobj) {
  for (var key in lobj.pages) {
    if (lobj.pages.hasOwnProperty(key)) {
      for (var i=0 ; i<lobj.pages[key].length ; i++) {
        delete lobj.pages[key][i]['id'];
      }      
    }
  }
}



function activatePage(pName) {
  // data = getData(1);
  data = jsonObj;
  data["menu"]["view"]["active"] = pName;
  var pageData = data["pages"][data["menu"]["view"]["active"]];
  cleanPage($("#contentcontainer"), $("#contentcontainer"), pName);
  
  loadMenu( $("#menucontainer"), $("#contentcontainer"), pageData );
  loadPage( $("#contentcontainer"), pageData );    
}

function cleanPage(container, menuContainer, pName) {
  container.empty();      // clean container
  menuContainer.empty();  // clean menu
  picndoOBJs = {};        // clean all objects
}

var elementsCounter = 0;

// TBD - TODO 
function modifyMenuType() {

}

function loadMenu(container, contentcontainer, pData) {

  // empty menu
  container.empty();

  // remove all classes
  container.removeClass();
  contentcontainer.removeClass();

  var elId = 'picndo-obj' + elementsCounter;
  elementsCounter++;

  jsonObj["menu"]["id"] = elId;

  cbObj = {
    "elId"        : elId, 
    "widget_name" : "menu",
    // "container"   : ldiv1,          
    "container"   : container,
    "content"     : contentcontainer,
    "data"        : jsonObj["menu"],
    "path"        : "widgets/top-menu/",
  };
 
  loadWidgetSctipt("widgets/top-menu/top-menu.js", cbObj);          
}

function loadPage(container, pData) {

  // Elements
  var i;
  for (i=0; i<pData.length; i++) {
    
    var elId = 'picndo-obj' + elementsCounter;
    var ldiv = jQuery('<div/>', {
      class: 'picndo-row picndo-editable',
      id: elId,
    });
    container.append(ldiv);
    elementsCounter++;

    pData[i]["id"] = elId;

    cbObj = {
      "widget_name":pData[i]["widget_name"],
      "container":ldiv,          
      "data":pData[i],
    }

    switch (pData[i]["widget_name"]) {

      case 'slick-gallery':
        cbObj["path"] = "widgets/galleries/slick-scrolling-gallery/";
        loadWidgetSctipt("widgets/galleries/slick-scrolling-gallery/gallery.js", cbObj);
        break;
    
      case 'masonary-gallery':
        cbObj["path"] = "widgets/galleries/masonary/";
        loadWidgetSctipt("widgets/galleries/masonary/gallery.js", cbObj);      
        break;    

      case 'square-gallery':    
        cbObj["path"] = "widgets/galleries/square/";
        loadWidgetSctipt("widgets/galleries/square/gallery.js", cbObj);      
        break;    

      // case 'general-txt':
      //   cbObj["path"] = "widgets/general-txt/";        
      //   loadWidgetSctipt("widgets/general-txt/general-txt.js", cbObj);      
      //   break;
      case 'general-txt':
        cbObj["path"] = "widgets/froala-txt/";        
        loadWidgetSctipt("widgets/froala-txt/froala-txt.js", cbObj);      
        break;

      case 'multi-elements':        
        cbObj["path"] = "widgets/multi-elements/";        
        loadWidgetSctipt("widgets/multi-elements/multi-elements.js", cbObj);      
        break;

      default:
        alert("Unknown widget element");
        break;
    }
  }

  // $(".picndo-row").resizable();
}

// function loadMenu() {
//   var elId = 'picndo-obj' + elementsCounter;

//   var ldiv1 = jQuery('<div/>', {
//     // class: 'container-fluid'
//     class: 'container',
//     id:elId
//   }).append( jQuery('<div/>', {
//     class: 'row .picndo-editable'
//   }));

//   container.append(ldiv1);

//   cbObj = {
//     "widget_name":pData[i]["widget_name"],
//     "container":ldiv,          
//     "path":"widgets/galleries/slick-scrolling-gallery/",
//     "data":pData[i],
//   }
  
//   // $.getScript("widgets/" + data.menu.type + "/" + data.menu.type + ".js", function() {
//   $.getScript("widgets/" + jsonObj.menu.type + "/" + jsonObj.menu.type + ".js", function() {
//     //loadmenu($("#contentcontainer"), "widgets/top-menu/", data);
//     loadmenu(ldiv1, "widgets/top-menu/", jsonObj);
//   });  
// }

// function loadElement( ) {

// }

function remove_obj_from_json(lid) {
  
  var lactive = jsonObj["menu"]["view"]["active"];
  var active_len = jsonObj["pages"][lactive].length;
  
  for (var i = 0; i<active_len; i++) {
    if ( jsonObj["pages"][lactive][i].id == lid ) {
      jsonObj["pages"][lactive].splice(i, 1);
      return true;
    }
  }

  if ( i == active_len ) {
    alert('failed removing object from json');
    return false;
  }
}

// function createWidget(widgetName, container, pData) {
function createWidget(widgetName, container) {  
  
  container = typeof container !== 'undefined' ? container : $("#contentcontainer");

  var cbObj = {};

  var elId = 'picndo-obj' + elementsCounter;

  var ldiv = jQuery('<div/>', {
    class: 'picndo-row picndo-editable',
    id: elId,
  });
  elementsCounter++;
  container.append(ldiv);


  var ljson = { 
    "widget_name":  widgetName,
    "css":          { },
    "data":         { },
    "id":           elId,  
  };

  var lactive = jsonObj["menu"]["view"]["active"];
  jsonObj["pages"][lactive].push( ljson );
  
  switch (widgetName) {

    case 'general-txt':
      // cbObj = {
      //   "widget_name":widgetName,
      //   "container": ldiv,          
      //   "path": "widgets/general-txt/",
      //   "data":jsonObj["pages"][lactive][ jsonObj["pages"][lactive].length-1 ]
      // }    

      // loadWidgetSctipt("widgets/general-txt/general-txt.js", cbObj);      
      
      cbObj = {
        "widget_name":'froala-txt',
        "container": ldiv,          
        "path": "widgets/froala-txt/",
        "data":jsonObj["pages"][lactive][ jsonObj["pages"][lactive].length-1 ]
      }    

      loadWidgetSctipt("widgets/froala-txt/froala-txt.js", cbObj);       
      break;
    
    case 'square-gallery':
      cbObj = {
        "widget_name":widgetName,
        "container": ldiv,          
        "path": "widgets/galleries/square/",
        "data":jsonObj["pages"][lactive][ jsonObj["pages"][lactive].length-1 ]
      }    

      loadWidgetSctipt("widgets/galleries/square/gallery.js", cbObj);                
      break

    default:
      alert("Unknown widget element");
      break;  
  }  

}

function loadWidgetSctipt(jsURL, wData) {
  // TODO => this is wrong to make masonary gallery.js a must for square gallery => load all from header, no dynamically
  $.getScript( './widgets/galleries/masonary/gallery.js', function( ldata, textStatus, jqxhr ) {
    $.ajax({
      url: jsURL,
      dataType: 'script',
      success: function() {
        loadWidget(wData);
      }
    });
  });
}

// function loadWidet(container, wData) {
function loadWidget(wData) {
  var obj = null;

  console.log("loaded widget script for " + wData.widget_name);
  switch (wData["widget_name"]) {
    case 'slick-gallery':
      obj = new PDG_slick_gallery(wData.container, wData.path, wData.data);
      break;
    case 'masonary-gallery':
      obj = new PDG_masonary_gallery(wData.container, wData.path, wData.data);
      break;  
    case 'square-gallery': 
      obj = new PDG_square_gallery(wData.container, wData.path, wData.data);
      break;  
    // case 'general-txt':
    //   obj = new PDG_general_txt(wData.container, wData.path, wData.data);
    //   break;
    case 'general-txt':
    case 'froala-txt':
      obj = new PDG_froala_txt(wData.container, wData.path, wData.data);
      break;      
    case 'multi-elements':
      obj = new PDG_multi_elements(wData.container, wData.path, wData.data);
      break;
    case 'menu':
      // obj = new PDG_top_menu(wData.container, wData.path, wData.data);
      obj = new PDG_top_menu(wData.path, wData);
      break;    
  }

  if (obj != null) {
    // append obj to global scope
    // picndoOBJs[wData.container[0].id] = obj;

    // if (wData.data == undefined) {
    //   var default_data = obj.default_data();
    //   picndoOBJs[wData.container[0].id] = [obj, default_data]; 
    // } else {
    //   picndoOBJs[wData.container[0].id] = [obj, wData.data];
    // }

    if ( ( 'container' in obj ) && ( obj.container != undefined) ) {
      picndoOBJs[obj.container[0].id] = [obj, obj.data];
    } 
    else { // sometimes depends on other usync file loading => returns uninitialized
      picndoOBJs[wData.container[0].id] = [obj, obj.data];
    }
    
    
  }
}

// function get_container_for_obj_action(obj) {
//   var widgetContainer = $(obj).parents(".picndo-row")[0];
//   return widgetContainer;
// }

// function get_class_obj_from_container(container) {
//   var class_obj = picndoOBJs[container.id];
//   return class_obj;
// }

// function destroy_obj_and_element_for_event(obj) {
//   var widgetContainer = get_container_for_obj_action(obj);  

//   // delete the class obj
//   delete picndoOBJs[widgetContainer.id];

//   // delete the dom element
//   widgetContainer.remove();
// }

// function get_class_obj_for_event(obj) {
//   var widgetContainer = get_container_for_obj_action(obj)
//   var class_obj = get_class_obj_from_container(widgetContainer)
//   return class_obj
// }


// function edit_widget(obj) {  
//   var lwidget = get_class_obj_for_event(obj);
//   console.log('Editing ' + lwidget.data.widget_name);
// }



function storeData(index, data) {
  localStorage.setItem(index.toString(), JSON.stringify(data) );
}

function getData(index) {
  return JSON.parse(localStorage.getItem(index.toString()) );
}

function remove_page(name) {
  console.log('removing page ' + name);
  
  // TODO currently do not support multi layer (dropboxed) menus 
  console.log( 'TODO currently do not support multi layer (dropboxed) menus' ); 

  // remove from menu
  for (var i=0; i<jsonObj['menu']['pages'].length; i++) {
    if ( jsonObj['menu']['pages'][i][0]['name'] == name ) {
      jsonObj['menu']['pages'].splice(i, 1);
      break;
    }
  }
  
  // remove from pages
  delete delete jsonObj['pages'][name];

  // handle if active
  var active = jsonObj["menu"]["view"]["active"]
  if (name == active) {
    if ( jsonObj['menu']['pages'].length > 0 ) {
      var first = jsonObj['menu']['pages'][0][0]['name'];
      activatePage(first);
    }
  }
}

function add_page(name) {

  // check if such page allready exist
  for (var i=0; i<jsonObj['menu']['pages'].length; i++) {
    if ( jsonObj['menu']['pages'][i][0]['name'] == name ) {
      alert("page named " + name + "already exist")
      return;
    }
  }  

  var pageUrl = ("/" + name + ".html");
  jsonObj['menu']['pages'].push( [{ "name":name, "url":pageUrl },] );

  jsonObj['pages'][name] = [];

  activatePage(name);
}